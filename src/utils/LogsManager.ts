import type { Bot } from '../structures/index.js';
import * as discordTranscripts from 'discord-html-transcripts';
import {
    type ButtonInteraction,
    type CommandInteraction,
    EmbedBuilder,
    type GuildChannel,
    type Snowflake,
    type TextChannel,
} from 'discord.js';
import { promises as fs } from 'node:fs';
import YAML from 'yaml';

interface Config {
    logChannelId: Snowflake;
    enableTranscripts: boolean;
    transcriptLogsChannelId: Snowflake;
}

export class LogsManager {
    public static async logTicketCreation(
        interaction: CommandInteraction | ButtonInteraction,
        categoryLabel: string,
        client: Bot,
        ticketChannel: GuildChannel,
    ): Promise<void> {
        const logChannel = await LogsManager.getLogChannel(client);
        const embed = LogsManager.createLogEmbed(
            interaction,
            interaction.user.username,
            '#2FF200',
            '🎟️ Ticket Created',
            `- **Ticket Creator:** \n> ${interaction.user.username}\n\n- **Ticket:** \n> ${ticketChannel.toString()} \n> (${
                ticketChannel.name
            } - ID: ${ticketChannel.id}) \n\n- **Category:** \n> ${categoryLabel}`,
        );
        await logChannel.send({ embeds: [embed] });
    }

    public static async logTicketDeletion(
        interaction: CommandInteraction | ButtonInteraction,
        client: Bot,
        userName: string,
        categoryLabel: string,
        ticketChannel: GuildChannel,
        reason: string,
    ): Promise<void> {
        const config = await LogsManager.readConfigFile();
        const logChannel = await LogsManager.getLogChannel(client);

        const embed = LogsManager.createLogEmbed(
            interaction,
            userName,
            '#FF2400',
            '⛔ Ticket Closed',
            `- **Closed By:** \n> ${interaction.user.username}\n\n- **Ticket Creator:** \n> ${
                interaction.user.username
            }\n\n- **Ticket:** \n> ${ticketChannel.toString()} \n> (${ticketChannel.name} - ID: ${
                ticketChannel.id
            }) \n\n- **Category:** \n> ${categoryLabel}\n\n- **Reason:** \n> ${reason}`,
        );

        if (config.enableTranscripts) {
            try {
                const transcript = await discordTranscripts.createTranscript(ticketChannel as TextChannel);
                await logChannel.send({
                    embeds: [embed],
                    files: [transcript],
                });
            } catch (error) {
                client.logger.error('Failed to create transcript:', error);
                await logChannel.send({
                    embeds: [embed],
                    content: 'Failed to create transcript.',
                });
            }
        } else {
            await logChannel.send({ embeds: [embed] });
        }
    }

    public static async logTicketTranscript(
        interaction: CommandInteraction | ButtonInteraction,
        client: Bot,
        userName: string,
        ticketChannel: GuildChannel,
    ): Promise<void> {
        const config = await LogsManager.readConfigFile();
        const logChannel = await LogsManager.getLogChannel(client);
        const transcriptLogsChannel = (await client.channels.fetch(config.transcriptLogsChannelId)) as TextChannel;

        const embed = LogsManager.createLogEmbed(
            interaction,
            userName,
            '#3498DB',
            '📝 Transcript Generated',
            `- **Transcript Generated By:** \n> ${interaction.user.username}\n\n- **Ticket:** \n> ${ticketChannel.toString()} \n> (${
                ticketChannel.name
            } - ID: ${ticketChannel.id})`,
        );

        try {
            const transcript = await discordTranscripts.createTranscript(ticketChannel as TextChannel);
            await transcriptLogsChannel.send({
                embeds: [embed],
                files: [transcript],
            });
        } catch (error) {
            client.logger.error('Failed to create transcript:', error);
            await logChannel.send({
                embeds: [embed],
                content: 'Failed to create transcript.',
            });
        }
    }

    private static createLogEmbed(
        interaction: CommandInteraction | ButtonInteraction,
        userName: string,
        color: string,
        title: string,
        description: string,
    ): EmbedBuilder {
        const userAvatarURL = interaction.user.displayAvatarURL({ extension: 'png', size: 1024 });

        return new EmbedBuilder()
            .setThumbnail(userAvatarURL)
            .setAuthor({
                name: title,
                iconURL: userAvatarURL,
            })
            .setDescription(description)
            .setColor(color as any)
            .setFooter({
                text: `Action performed by ${userName}`,
                iconURL: userAvatarURL,
            })
            .setTimestamp();
    }

    private static async getLogChannel(client: Bot): Promise<TextChannel> {
        const { logChannelId } = await LogsManager.readConfigFile();
        const logChannel = (await client.channels.fetch(logChannelId)) as TextChannel;

        if (!logChannel) {
            throw new Error('Log channel not found');
        }

        return logChannel;
    }

    public static async readConfigFile(): Promise<Config> {
        try {
            const configFile = await fs.readFile('./config.yml', 'utf8');
            return YAML.parse(configFile) as Config;
        } catch (error) {
            throw new Error(`Failed to read config file: ${error.message}`);
        }
    }
}
